#!/bin/bash
set +e

# Combine and minify all the js files into one file to save on requests and bytes

cd media/js

echo 'Begin smooshing searcher.js'

#  Minify the variable names.
#  Each script is put in its own function scope so other scripts should (in theory) have no problems with this
cat searcher.js > temp.js
grasp -i '#$noResults' -R z temp.js
grasp -i '#$searchBox' -R y temp.js
grasp -i '#$entries' -R x temp.js
grasp -i '#searchTimeout' -R w temp.js
grasp -i '#firstRun' -R v temp.js
grasp -i '#loc' -R u temp.js
grasp -i '#hist' -R t temp.js
grasp -i '#win' -R s temp.js
grasp -i '#searchTerm' -R r temp.js
grasp -i '#rePattern' -R q temp.js
grasp -i '#searchPattern' -R p temp.js
grasp -i '#textToCheck' -R o temp.js
grasp -i '#searchVal' -R n temp.js

# Function names
grasp -i '#filter' -R m temp.js
grasp -i '#reset' -R l temp.js

cat temp.js > tmcscripts.js
rm temp.js

echo 'Begin smooshing video.js'

# Begin the smooshing of video.js
cat video.js > temp.js

grasp -i '#videos' -R z temp.js
grasp -i '#leftZeroPad' -R y temp.js
grasp -i '#numZeros' -R x temp.js
grasp -i '#zeros' -R w temp.js
grasp -i '#zeroString' -R v temp.js
grasp -i '#isVideoPlaying' -R u temp.js
grasp -i '#video' -R t temp.js
grasp -i '#playPause' -R s temp.js
grasp -i '#vid' -R r temp.js
grasp -i '#playPauseButton' -R q temp.js
grasp -i '#rawTimeToFormattedTime' -R p temp.js
grasp -i '#rawTime' -R o temp.js
grasp -i '#chomped' -R n temp.js
grasp -i '#seconds' -R m temp.js
grasp -i '#minutes' -R l temp.js
grasp -i '#$video' -R k temp.js
grasp -i '#$videoContainer' -R j temp.js
grasp -i '#$controlsBox' -R i temp.js
grasp -i '#$playPauseButton' -R h temp.js
grasp -i '#$progressBar' -R g temp.js
grasp -i '#$poster' -R f temp.js
grasp -i '#customPoster' -R e temp.js
grasp -i '#$endPoster' -R d temp.js
grasp -i '#customEndPoster' -R c temp.js
grasp -i '#$errorPoster' -R b temp.js
grasp -i '#$currentTimeSpan' -R a temp.js
grasp -i '#$durationTimeSpan' -R zz temp.js
grasp -i '#svg' -R zy temp.js
grasp -i '#canPlayVid' -R zx temp.js
grasp -i '#newText' -R zw temp.js
grasp -i '#link' -R zv temp.js
grasp -i '#videoContainerOffset' -R zu temp.js
grasp -i '#videoContainerWidth' -R zt temp.js
grasp -i '#heightsTogether' -R zs temp.js
grasp -i '#doc' -R zr temp.js

cat temp.js >> tmcscripts.js
rm temp.js

# Finished with video.js

echo 'Finished with home brew scripts'
echo 'Begin general minification'

sed -i 's/[^:]\/\/.*//g' tmcscripts.js            # Dont need comments (and they become greedy when everything is on a single line). [:] is for urls (which have //)
sed -i 's/ #\*.*$//'g tmcscripts.js               # Dont need comments (and they become greedy when everything is on a single line)
sed -i '/console.*/'d tmcscripts.js               # Debug statements
sed -i 's/^[ \t]*//' tmcscripts.js                # Leading whitespace and tabs N.B in theory there shouldnt need to be tabs anywhere but I am sure there will be
sed -i 's/[ \t]*$//' tmcscripts.js                # Trailing whitespace and tabs
sed -i 's/ () /()/g' tmcscripts.js                # Spaces in 'function () {'
sed -i 's/ + /+/g' tmcscripts.js                  # Spaces in 'x + y'
sed -i 's/ || /||/g' tmcscripts.js                # Spaces in 'x || y'
sed -i 's/for (/for(/g' tmcscripts.js             # Spaces in 'for (' Usually in a for loop
sed -i 's/; /;/g' tmcscripts.js                   # Spaces in '; ' Usually in a for loop
sed -i 's/ \(<\|<=\|>\|>=\) /\1/g' tmcscripts.js  # Spaces in 'x < y|x > y|x <= y|x >= y' Usually in a for loop
sed -i 's/ \(+=\|-=\) /\1/g' tmcscripts.js        # Spaces in 'x += y|x -= y'
sed -i 's/ \(=\+\) /\1/g' tmcscripts.js           # Spaces in 'x = y', 'x == y', 'x === y'
sed -i 's/) {/){/g' tmcscripts.js                 # End of parameter list and opening curly brace
sed -i 's/if (/if(/g' tmcscripts.js               # End of if and opening round bracket
sed -i 's/, \(.\)/,\1/g' tmcscripts.js            # Comma space anything
sed -i ':a;N;$!ba;s/\n//g' tmcscripts.js          # New lines N.B. Put this at the end otherwise other operation (like get rid of leading white space) get confused

echo 'Finished  general minification'

echo 'Adding in GA (unmolested)'
# GS is already optimised and mucking with it furthur seems to break things so just append it at the end
cat ga.js >> tmcscripts.js

echo 'Finished with GA'
echo 'Finished combining all JavaScript files'
